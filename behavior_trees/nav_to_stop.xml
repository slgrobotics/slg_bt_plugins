<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <BehaviorTree ID="MainTree">
    <!-- 
      SuccessThreshold="1": The Parallel returns SUCCESS if at least 1 child succeeds.
      FailureThreshold="1": The Parallel returns FAILURE if any child fails.
    -->
    <Parallel SuccessThreshold="1" FailureThreshold="1">
      
      <!-- 1. Background Data Pump: Runs constantly -->
      <KeepRunningUntilFailure>

        <Sequence name="DataPumpRoot">

          <!-- Pump perception data into the Blackboard -->
          <FgsTopicToBlackboard
            topic_name="/bt/face_gesture_detect"
            is_face_detected="{is_face_detected}"
            face_yaw_error="{face_yaw_error}"
            is_stop_gesture="{is_stop_gesture}"
            is_like_gesture="{is_like_gesture}"
            is_ok_gesture="{is_ok_gesture}"
            is_yes_gesture="{is_yes_gesture}"
            is_six_gesture="{is_six_gesture}"
          />
          <!-- Always succeed so the Sequence keeps ticking -->
          <AlwaysSuccess/>

        </Sequence>

      </KeepRunningUntilFailure>

      <!-- 2. Main Logic: Reacts to the data on the Blackboard -->
      <ReactiveSequence>

        <!-- 
          This Precondition checks 'is_stop_gesture' on Blackboard. 
          The precondition will be re-evaluated every tick. 
          If 'is_stop_gesture' becomes true, this branch returns FAILURE
             and it forces the branch to FAILURE (stopping navigation).
          If false, it executes the child (NavigateToPose).
        -->
        <Precondition if="is_stop_gesture == false" else="FAILURE">
          <NavigateToPose goal="{goal}" />
        </Precondition>

        <!-- 
            If precondition or navigation fails (either due to the gesture or a path issue), 
            perform a recovery behavior like waiting. 
        -->
        <Wait duration="2.0" />

      </ReactiveSequence>

    </Parallel>
  </BehaviorTree>
</root>
